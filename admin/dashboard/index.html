<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <script src="setting.js"></script>
  <style>
    :root {
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #222;
      --primary: #007bff;
      --sidebar: #ffffff;
      --shadow: rgba(0, 0, 0, 0.08);
    }
    body.dark {
      --bg: #1e1e2e;
      --card: #2a2a3d;
      --text: #eee;
      --sidebar: #252536;
      --shadow: rgba(0, 0, 0, 0.3);
    }
    * { box-sizing: border-box; transition: background-color .3s, color .3s; }
    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
    aside {
      width: 250px;
      background: var(--sidebar);
      box-shadow: 2px 0 10px var(--shadow);
      display: flex;
      flex-direction: column;
      padding: 20px;
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      z-index: 999;
      transform: translateX(-100%);
      transition: transform .3s ease;
    }
    aside.show { transform: translateX(0); }
    aside h2 { font-size: 20px; margin-bottom: 30px; }
    nav button {
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      padding: 12px;
      margin-bottom: 10px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
    }
    nav button:hover, nav button.active { background: var(--primary); color: white; }
    main { flex: 1; padding: 30px; overflow-y: auto; margin-left: 0; transition: margin-left .3s ease; }
    .page { display: none; animation: fadeIn .4s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }
    .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px var(--shadow); margin-bottom: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
    .stat { font-size: 18px; margin: 8px 0; }
    .stat strong { color: var(--primary); }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .toggle-dark { background: transparent; border: 1px solid var(--text); color: var(--text); padding: 6px 12px; cursor: pointer; border-radius: 6px; }
    .hamburger { font-size: 24px; background: none; border: none; color: var(--text); cursor: pointer; margin-right: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
    input, select, button[type=submit] { width: 100%; padding: 10px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; }
    button[type=submit] { background: var(--primary); color: #fff; border: none; cursor: pointer; }

    .spinner{
      border:4px solid #f3f3f3;
      border-top:4px solid #007bff;
      border-radius:50%;
      width:30px;
      height:30px;
      animation:spin 1s linear infinite;
      margin:10px auto 0;
    }
    @keyframes spin{to{transform:rotate(360deg);}}
  </style>
</head>
<body>

<aside id="sidebar">
  <h2>Admin Panel</h2>
  <nav>
    <button class="nav-btn active" data-page="dashboard">üìä Dashboard</button>
    <button class="nav-btn" data-page="server">üñ• Server</button>
    <button class="nav-btn" data-page="reseller">üë§ Reseller</button>
    <button class="nav-btn" data-page="create">‚ûï Create User</button>
    <button class="nav-btn" data-page="createpanel">üß© Create Panel</button>
  </nav>
</aside>

<main id="main">
  <div class="topbar">
    <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
    <h1 id="pageTitle">Dashboard</h1>
    <button class="toggle-dark" onclick="toggleDark()">üåô Dark</button>
  </div>

  <!-- Dashboard -->
  <div class="page active" id="dashboard">
    <div class="card">
      <h3>üìä Informasi Sistem</h3>
      <div class="grid">
        <div class="stat">üïí <strong>Jam:</strong> <span id="clock">--:--:--</span></div>
        <div class="stat">üåê <strong>IP:</strong> <span id="ip">Memuat...</span></div>
        <div class="stat">üîã <strong>Baterai:</strong> <span id="battery">Tidak tersedia</span></div>
        <div class="stat">üë• <strong>Total User:</strong> <span id="totalUsers">42</span></div>
        <div class="stat">üñ• <strong>Total Server:</strong> <span id="totalServers">5</span></div>
      </div>
    </div>
  </div>

  <!-- SERVER -->
  <div class="page" id="server">
    <div class="card">
      <h3>Daftar Server (API)</h3>
      <button onclick="loadServers()" style="margin-bottom:12px">üîÑ Refresh</button>
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th style="padding:8px;border-bottom:1px solid #ccc">#</th>
            <th style="padding:8px;border-bottom:1px solid #ccc">Nama</th>
            <th style="padding:8px;border-bottom:1px solid #ccc">Identifier</th>
            <th style="padding:8px;border-bottom:1px solid #ccc">Owner</th>
          </tr>
        </thead>
        <tbody id="serverTableBody">
          <tr><td colspan="4" style="text-align:center;padding:20px">‚è≥ Memuat server...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Reseller -->
  <div class="page" id="reseller">
    <div class="card">
      <h3>Daftar Reseller</h3>
      <button onclick="loadResellers()" style="margin-bottom:10px;padding:8px 14px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer;">üîÑ Refresh</button>
      <input type="text" id="searchReseller" placeholder="üîç Cari reseller berdasarkan username..." style="width:100%;padding:10px;margin-bottom:15px;border-radius:8px;border:1px solid #ccc;" onkeyup="filterReseller()">
      <table id="resellerTable">
        <thead><tr><th>#</th><th>Username</th><th>Password</th><th>Dibuat</th><th>Aksi</th></tr></thead>
        <tbody><tr><td colspan="4">‚è≥ Memuat data reseller...</td></tr></tbody>
      </table>
      <p id="lastUpdate" style="font-size:12px;color:#888;margin-top:10px;">Terakhir diperbarui: -</p>
    </div>
  </div>

  <!-- Create User -->
  <div class="page" id="create">
    <div class="card" style="max-width: 400px; margin: 0 auto;">
      <h3>Buat Akun Baru</h3>
      <input type="text" id="username" placeholder="Username" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="registerUser()">Daftar</button>
    </div>
  </div>

  <!-- Create Panel -->
  <div class="page" id="createpanel">
    <div class="card">
      <h3>Buat Panel Baru</h3>
      <form onsubmit="event.preventDefault(); alert('Panel berhasil dibuat!');">
        <input type="text" placeholder="Nama Panel" required />
        <select required>
          <option value="">Pilih Tipe</option>
          <option>Game</option>
          <option>VPN</option>
        </select>
        <button type="submit">Buat Panel</button>
      </form>
    </div>
  </div>
</main>

<script>
  const buttons = document.querySelectorAll('.nav-btn');
  const pages = document.querySelectorAll('.page');
  const pageTitle = document.getElementById('pageTitle');
  const sidebar = document.getElementById('sidebar');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-page');
      buttons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      pages.forEach(p => p.classList.remove('active'));
      document.getElementById(target).classList.add('active');
      pageTitle.textContent = btn.textContent.slice(2);
      sidebar.classList.remove('show');

      if (target === 'reseller') loadResellers();
    });
  });

  function toggleDark() { document.body.classList.toggle('dark'); }
  function toggleSidebar() { sidebar.classList.toggle('show'); }

  // Jam real-time
  function updateClock() {
    const now = new Date();
    document.getElementById('clock').textContent = now.toLocaleTimeString('id-ID');
  }
  setInterval(updateClock, 1000);
  updateClock();

  // IP Publik
  fetch('https://api.ipify.org?format=json')
    .then(res => res.json())
    .then(data => document.getElementById('ip').textContent = data.ip)
    .catch(() => document.getElementById('ip').textContent = 'Gagal memuat IP');

  // Baterai
  if ('getBattery' in navigator) {
    navigator.getBattery().then(battery => {
      function updateBattery() {
        const level = Math.round(battery.level * 100);
        const charging = battery.charging ? 'üîå Charging' : 'üîã Baterai';
        document.getElementById('battery').textContent = `${charging}: ${level}%`;
      }
      updateBattery();
      battery.addEventListener('levelchange', updateBattery);
      battery.addEventListener('chargingchange', updateBattery);
    });
  } else {
    document.getElementById('battery').textContent = 'Tidak tersedia';
  }

  // Fungsi load reseller dari API /api/getUsers
  async function loadResellers() {
    const tbody = document.querySelector("#resellerTable tbody");
    const last = document.getElementById("lastUpdate");
    tbody.innerHTML = "<tr><td colspan='4'>‚è≥ Memuat...</td></tr>";

    try {
      const token = localStorage.getItem("admin_token");
      if (!token) return (window.location.href = "/admin/login.html");

      const res = await fetch("/api/getUsers", {
        headers: { Authorization: "Bearer " + token }
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.message || "Gagal ambil data reseller");

      tbody.innerHTML = "";
      data.users.forEach((u, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${u.username}</td>
          <td>${u.password}</td>
          <td>${new Date(u.created_at).toLocaleString()}</td>
          <td>
            <button onclick="deleteUser('${u.username}')" style="background:#e74c3c;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">Hapus</button>
          </td>`;
        tbody.appendChild(tr);
      });
      last.textContent = "Terakhir diperbarui: " + new Date().toLocaleTimeString();
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="4" style="color:red;">‚ùå ${err.message}</td></tr>`;
    }
  }

  // Fungsi filter pencarian reseller
  function filterReseller() {
    const input = document.getElementById("searchReseller").value.toLowerCase();
    const rows = document.querySelectorAll("#resellerTable tbody tr");

    rows.forEach(row => {
      const username = row.cells[1]?.textContent.toLowerCase();
      row.style.display = username && username.includes(input) ? "" : "none";
    });
  }

  // create akun 
  async function registerUser() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!username || !password) {
      alert('‚ùå Username dan Password wajib diisi!');
      return;
    }

    try {
      const res = await fetch('/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      const data = await res.json();

      if (res.ok) {
        alert('‚úÖ User berhasil dibuat!');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
      } else {
        alert('‚ùå ' + (data.error || 'Gagal membuat user'));
      }
    } catch (err) {
      alert('‚ùå Terjadi kesalahan: ' + err.message);
    }
  }

  // delete 
  async function deleteUser(username) {
    if (!confirm(`Yakin ingin menghapus user "${username}"?`)) return;

    try {
      const token = localStorage.getItem("admin_token");
      if (!token) return (window.location.href = "/admin/login.html");

      const res = await fetch("/api/deleteUser", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({ username })
      });

      const data = await res.json();
      if (res.ok) {
        alert("‚úÖ User berhasil dihapus");
        loadResellers(); // reload tabel
      } else {
        alert("‚ùå " + (data.error || "Gagal menghapus user"));
      }
    } catch (err) {
      alert("‚ùå Terjadi kesalahan: " + err.message);
    }
  }

  // Fungsi load server dari API
  async function loadServers(){
    const tbody = document.getElementById('serverTableBody');
    tbody.innerHTML = `
      <tr>
        <td colspan="4" style="text-align:center;padding:20px">
          <div>‚è≥ Memuat server...</div>
          <small>Estimasi 30-90 detik</small>
          <div class="spinner"></div>
        </td>
      </tr>`;

    const { domain, plta } = window.SETTINGS;
    const url = `https://api.resellergaming.my.id/pterodactyl/listserver?domain=${encodeURIComponent(domain)}&plta=${plta}`;

    // Fetch dengan timeout 120 detik
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 120_000);

    try{
      const r = await fetch(url, { signal: controller.signal });
      clearTimeout(timeoutId);
      const j = await r.json();

      if(!j.status) throw new Error(j.message || 'API gagal');

      tbody.innerHTML = '';
      j.servers.forEach((s, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:8px">${i + 1}</td>
          <td style="padding:8px">${s.name}</td>
          <td style="padding:8px">${s.identifier}</td>
          <td style="padding:8px">${s.owner_id}</td>`;
        tbody.appendChild(tr);
      }); // ‚úÖ Kurung tutup ini sudah benar

    } catch(err){
      let msg = err.name === 'AbortError' ? '‚è± Request timeout (120 detik)' : err.message;
      tbody.innerHTML = `<tr><td colspan="4" style="color:red;text-align:center;padding:20px">‚ùå ${msg}</td></tr>`;
    }
  }

  // Panggil saat halaman server dibuka
  document.querySelector('[data-page="server"]').addEventListener('click', loadServers);

</script>
</body>
  </html>
